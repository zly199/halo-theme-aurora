<th:block th:fragment="post-card(feature,post)">
    <style>
        #imgHref:hover {
            opacity: 1;
        }
        .article-thumbnail {
            height: 230%;
            position: relative; /* 确保内部绝对定位可用 */
            overflow: hidden;
        }
        /* 确保 video 初始不可见，并去除默认背景 */
        .artile-video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 50;
            display: none;
            background: none;
        }
    </style>

    <!-- 主体结构 -->
    <li class="article-container"
        th:if="${post != null}"
        th:with="default_img=${#strings.contains(theme.config.article.default_img,'http')
               ? ((#strings.contains(theme.config.article.default_img,'?')
               ? theme.config.article.default_img
               : theme.config.article.default_img+'?')+','+post.spec.title)
               : theme.config.article.default_img}"
        th:data-cover-gif="${post.metadata.annotations['coverGIf']}">

        <span th:if="${feature}" class="article-tag">
            <b>
                <svg class="svg-icon">
                    <use href="#icon-hot" fill="currentColor" stroke="var(--background-primary)"></use>
                </svg> 推荐
            </b>
        </span>

        <div class="article">
            <a id="imgHref" th:href="@{${post.status.permalink}}">
                <div class="article-thumbnail">
                    <!-- 如果没有专门海报图，就以 default_img 代替 -->
                    <img alt=""
                         lazy="loading"
                         th:src="${#strings.isEmpty(post.spec.cover) ? default_img : post.spec.cover}">

                    <!-- 关键：video preload="none" + display:none，避免先行加载和白屏 -->
                    <video class="artile-video"
                           preload="none"
                           muted
                           playsinline
                           loop>
                        <source src="" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
            </a>

            <div class="article-content" style="margin-top: 90px; padding-bottom: 0em;">
                <a th:href="@{${post.status.permalink}}">
                    <h1 data-dia="article-link"
                        th:text="${post.spec.title}"
                        style="line-height:1.2em; margin-bottom:0em; max-height:3em; overflow:hidden;
                               text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2;
                               -webkit-box-orient:vertical; font-size:0.9em;">
                    </h1>
                </a>
                <p th:text="${post.status.excerpt}" class="article-content" style="display:none;"></p>
                <div class="article-footer" th:with="owner=${post.owner}"
                     style="display: flex; justify-content: space-between;">
                    <div class="flex flex-row items-center">
                        <span>
                            <th:block th:if="${not #lists.isEmpty(post.categories)}"
                                      th:each="category,stat : ${post.categories}">
                                <a th:if="${stat.index}<=2" th:href="@{${category.status.permalink}}">
                                    <b>[[${category.spec.displayName}]]</b>
                                </a>
                            </th:block>
                        </span>
                    </div>
                    <span class="text-ob-dim">
                        [[${#dates.format(post.spec.publishTime, 'yyyy-MM-dd')}]]
                    </span>
                </div>
            </div>
        </div>
    </li>

    <!-- JS逻辑：hover播放、离开暂停、移动端点击处理、只有canplay后才显示视频 -->
    <script>
        // 悬停/点击时加载并播放
        function loadAndPlayVideo(element) {
            const video = element.querySelector('video');
            const source = video.querySelector('source');
            const coverGif = element.getAttribute('data-cover-gif');
            const img = element.querySelector('img');

            // 如果已加载过，则直接播放并显示
            if (video.dataset.loaded === 'true') {
                video.dataset.playing = 'true';
                video.play();
                video.style.display = 'block'; // 直接显示
                if (img) img.style.display = 'none';
                return;
            }

            // 第一次加载
            if (coverGif && source.src !== coverGif) {
                source.src = coverGif;
                video.load();
            }

            // 使用 canplay 事件，确保至少解码了一帧才显示
            const onCanPlay = () => {
                video.removeEventListener('canplay', onCanPlay);
                // 如果用户依然想播放(鼠标没离开)才显示
                if (video.dataset.playing === 'true') {
                    video.style.display = 'block';
                    if (img) img.style.display = 'none';
                }
            };
            video.__onCanPlay = onCanPlay;
            video.addEventListener('canplay', onCanPlay);

            // 标记正在播放
            video.dataset.playing = 'true';
            video.play();
            video.dataset.loaded = 'true'; // 只标记一次
        }

        // 鼠标离开后暂停并隐藏视频
        function pauseVideo(element) {
            if (window.innerWidth <= 1024) {
                // 移动端不做悬停暂停
                return;
            }
            const video = element.querySelector('video');
            const img = element.querySelector('img');

            // 若还没触发 canplay 就离开，需要移除监听
            if (video.__onCanPlay) {
                video.removeEventListener('canplay', video.__onCanPlay);
                delete video.__onCanPlay;
            }

            video.pause();
            video.removeAttribute('data-playing');
            video.style.display = 'none';
            if (img) {
                img.style.display = 'block';
            }
        }

        document.querySelectorAll('.article-container').forEach(container => {
            let clickedOnce = false;

            // PC端鼠标悬停
            container.addEventListener('mouseenter', () => {
                loadAndPlayVideo(container);
            });
            container.addEventListener('mouseleave', () => {
                pauseVideo(container);
            });

            // 移动端或PC端点击
            container.addEventListener('click', (event) => {
                const coverGif = container.getAttribute('data-cover-gif');

                // 移动端逻辑
                if (window.innerWidth <= 1024) {
                    // 第一次点击只播放
                    if (!clickedOnce && coverGif) {
                        event.preventDefault(); // 阻止立即跳转
                        loadAndPlayVideo(container);
                        clickedOnce = true;
                    } else {
                        // 第二次点击才跳转
                        const link = container.querySelector('a');
                        if (link) {
                            window.location.href = link.href;
                        }
                    }
                }
                // PC端点击直接跳转
                else {
                    const link = container.querySelector('a');
                    if (link) {
                        window.location.href = link.href;
                    }
                }
            });
        });
    </script>
</th:block>
