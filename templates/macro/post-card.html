<th:block th:fragment="post-card(feature,post)">
    <style>
        #imgHref:hover {
            opacity: 1;
        }
        .article-thumbnail {
            height: 230%;
        }
    </style>
    <li class="article-container"
        th:if="${post != null}"
        th:with="default_img=${#strings.contains(theme.config.article.default_img,'http')
               ? ((#strings.contains(theme.config.article.default_img,'?')
               ? theme.config.article.default_img
               : theme.config.article.default_img+'?')+','+post.spec.title)
               : theme.config.article.default_img}"
        th:data-cover-gif="${post.metadata.annotations['coverGIf']}">

        <span th:if="${feature}" class="article-tag">
            <b>
                <svg class="svg-icon">
                    <use href="#icon-hot" fill="currentColor"
                         stroke="var(--background-primary)"></use>
                </svg> 推荐
            </b>
        </span>

        <div class="article">
            <a id="imgHref" th:href="@{${post.status.permalink}}">
                <div class="article-thumbnail">
                    <img alt="" lazy="loading"
                         th:src="${#strings.isEmpty(post.spec.cover) ? default_img : post.spec.cover}">
                    <!-- 关键：preload="none" 避免在页面加载时就请求视频 -->
                    <video class="artile-video" preload="none" muted playsinline
                           style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                                  object-fit: cover; z-index: 50; display: none;"
                           loop>
                        <source src="" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
            </a>

            <div class="article-content" style="margin-top: 90px;padding-bottom: 0em">
                <a th:href="@{${post.status.permalink}}">
                    <h1 data-dia="article-link"
                        th:text="${post.spec.title}"
                        style="line-height: 1.2em;margin-bottom: 0em; max-height: 3em; overflow: hidden;
                               text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2;
                               -webkit-box-orient: vertical; font-size: 0.9em;">
                    </h1>
                </a>
                <p th:text="${post.status.excerpt}" class="article-content" style="display: none"></p>
                <div class="article-footer" th:with="owner=${post.owner}"
                     style="display: flex; justify-content: space-between;">
                    <div class="flex flex-row items-center">
                        <span>
                            <th:block th:if="${not #lists.isEmpty(post.categories)}"
                                      th:each="category,stat : ${post.categories}">
                                <a th:if="${stat.index}<=2" th:href="@{${category.status.permalink}}">
                                    <b>[[${category.spec.displayName}]]</b>
                                </a>
                            </th:block>
                        </span>
                    </div>
                    <span class="text-ob-dim">
                        [[${#dates.format(post.spec.publishTime, 'yyyy-MM-dd')}]]
                    </span>
                </div>
            </div>
        </div>
    </li>

    <script>
        function loadAndPlayVideo(element) {
            const video = element.querySelector('video');
            const source = video.querySelector('source');
            const coverGif = element.getAttribute('data-cover-gif');

            // 如果已经加载过一次，就直接播放，无需再次 load()
            if (video.dataset.loaded === 'true') {
                video.play();
                showVideoStyles(element, video);
                return;
            }

            // 第一次加载
            if (coverGif && source.src !== coverGif) {
                source.src = coverGif;
                video.load();
            }
            video.play();
            video.dataset.loaded = 'true';  // 做标记

            showVideoStyles(element, video);
        }

        function pauseVideo(element) {
            // 移动端不执行暂停
            if (window.innerWidth <= 1024) return;

            const video = element.querySelector('video');
            video.pause();
            video.style.display = 'none';

            const img = element.querySelector('img');
            if (img) {
                img.style.display = 'block';
            }
            const thumbnailScreen = element.querySelector('.thumbnail-screen');
            if (thumbnailScreen) {
                thumbnailScreen.style.display = 'block';
            }
        }

        // 抽取出一个方法，设置播放时的样式
        function showVideoStyles(element, video) {
            video.style.display = 'block';

            const img = element.querySelector('img');
            if (img) {
                img.style.display = 'none';
            }
            const thumbnailScreen = element.querySelector('.thumbnail-screen');
            if (thumbnailScreen) {
                thumbnailScreen.style.display = 'none';
            }
        }

        document.querySelectorAll('.article-container').forEach(container => {
            let clickedOnce = false;

            container.addEventListener('mouseenter', () => {
                loadAndPlayVideo(container);
            });

            container.addEventListener('mouseleave', () => {
                pauseVideo(container);
            });

            container.addEventListener('click', (event) => {
                const coverGif = container.getAttribute('data-cover-gif');
                // 移动端逻辑
                if (window.innerWidth <= 1024) {
                    // 第一次点击只播放，不跳转；第二次点击再跳转
                    if (!clickedOnce && coverGif) {
                        event.preventDefault();
                        loadAndPlayVideo(container);
                        clickedOnce = true;
                    } else {
                        const link = container.querySelector('a');
                        if (link) {
                            window.location.href = link.href;
                        }
                    }
                }
                // PC端逻辑：直接跳转
                else {
                    const link = container.querySelector('a');
                    if (link) {
                        window.location.href = link.href;
                    }
                }
            });
        });
    </script>
</th:block>
